FROM node:20 AS builder
WORKDIR /app

# Set API URL to use same origin (nginx will proxy /api to backend)
ARG VITE_API_BASE_URL=/api
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}

COPY frontend/package.json ./package.json
COPY frontend/tsconfig*.json ./
COPY frontend/vite.config.ts ./vite.config.ts
COPY frontend/index.html ./index.html
COPY frontend/src ./src

# Remove any .env files that might have been copied
RUN rm -f .env .env.local .env.production .env.production.local

# Verify the environment variable is set correctly
RUN echo "Building with VITE_API_BASE_URL=${VITE_API_BASE_URL}"

RUN npm install
RUN npm run build

FROM nginx:alpine
WORKDIR /usr/share/nginx/html

# Copy custom nginx configuration
COPY local/nginx-frontend.conf /etc/nginx/conf.d/default.conf

# Copy built files
COPY --from=builder /app/build ./

EXPOSE 80
